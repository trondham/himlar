---
# Configuration for Designate (DNS)
#
# Uses puppet-designate:
#   https://github.com/openstack/puppet-designate
#
# UH-IaaS internal documentation:
#   https://iaas.readthedocs.io/en/latest/team/operations/designate.html

#---------------------------------------------------------------------
# Logging (manifests/logging.pp)
#---------------------------------------------------------------------
designate::logging::use_syslog:  true
designate::logging::use_journal: true
designate::logging::use_json:    false

#---------------------------------------------------------------------
# RabbitMQ (manifests/init.pp)
#---------------------------------------------------------------------
designate::default_transport_url:       "%{hiera('service__transport__url')}"
designate::notification_transport_url:  "%{hiera('service__transport__url')}"

#---------------------------------------------------------------------
# Authentication (manifests/keystone/auth.pp)
#---------------------------------------------------------------------
designate::keystone::auth::region:       "%{hiera('location_environment')}"
designate::keystone::auth::public_url:   "%{hiera('endpoint__designate__public')}"
designate::keystone::auth::admin_url:    "%{hiera('endpoint__designate__admin')}"
designate::keystone::auth::internal_url: "%{hiera('endpoint__designate__internal')}"
designate::keystone::auth::password:     "%{hiera('designate_api_password')}"

#---------------------------------------------------------------------
# Authentication tokens (manifests/keystone/authtoken.pp)
#---------------------------------------------------------------------
designate::keystone::authtoken::password:          "%{hiera('designate_api_password')}"
designate::keystone::authtoken::auth_url:          "%{hiera('endpoint__identity__admin')}"
designate::keystone::authtoken::auth_uri:          "%{hiera('endpoint__identity__public')}"
designate::keystone::authtoken::memcached_servers: '127.0.0.1'

#---------------------------------------------------------------------
# Central (manifests/central.pp)
#---------------------------------------------------------------------
designate::central::backend_driver:             'bind9'
designate::central::managed_resource_email:     'iaas-core@usit.uio.no'
designate::central::min_ttl:                    '300'

#---------------------------------------------------------------------
# API (manifests/api.pp)
#---------------------------------------------------------------------
designate::api::auth_strategy:     'keystone'
designate::api::keystone_host:     "identity.%{hiera('domain_trp')}"
designate::api::keystone_port:     '35357'
designate::api::keystone_protocol: 'http'
designate::api::keystone_tenant:   'services'
designate::api::keystone_user:     'designate'
designate::api::keystone_password: "%{hiera('designate_api_password')}"
designate::api::enable_api_v1:     false
designate::api::enable_api_v2:     true
designate::api::enabled_extensions_v2:
  - 'quotas'
  - 'reports'
# needs to be '0.0.0.0' for it to bind to localhost as well
designate::api::listen:             "0.0.0.0:9001"
designate::api::api_base_uri:       "%{hiera('endpoint__designate__internal')}"

#---------------------------------------------------------------------
# Database (manifests/db.pp)
#---------------------------------------------------------------------
designate::db::database_connection: "mysql+pymysql://designate:%{hiera('designate::db::mysql::password')}@db01.%{hiera('domain_trp')}/designate"
designate::db::sync_db: true
designate::db::database_max_retries: "-1"

#---------------------------------------------------------------------
# Database MySQL (manifests/db/mysql.pp)
#---------------------------------------------------------------------
designate::db::mysql::host:   "db01.%{hiera('domain_trp')}"
designate::db::mysql::user:   "designate"
designate::db::mysql::dbname: "designate"
designate::db::mysql::allowed_hosts:
  - "%{ipaddress_service1}"
  - 'localhost'
  - '%'

#---------------------------------------------------------------------
# Bind9 backend (manifests/backend/bind9.pp)
#---------------------------------------------------------------------
designate::backend::bind9::rndc_host: "%{hiera('service__address__ns')}"

#---------------------------------------------------------------------
# mDNS (manifests/mdns.pp)
#---------------------------------------------------------------------
# use defaults

#---------------------------------------------------------------------
# Producer (manifests/producer.pp)
#---------------------------------------------------------------------
# use defaults

#---------------------------------------------------------------------
# Worker (manifests/worker.pp)
#---------------------------------------------------------------------
# use defaults

#---------------------------------------------------------------------
# Pool Manager (manifests/pool_manager.pp)
#---------------------------------------------------------------------
# pool manager is deprecated

#---------------------------------------------------------------------
# Pool Manager Cache (manifests/pool_manager_cache/memcache.pp)
#---------------------------------------------------------------------
# pool manager is deprecated

#---------------------------------------------------------------------
# Sink [NOT USED] (manifests/sink.pp)
#---------------------------------------------------------------------
#designate::sink::enabled_notification_handlers:
#  - "nova_fixed"

#---------------------------------------------------------------------
# Extra config [NOT NEEDED WITHOUT SINK] (manifests/config.pp)
#---------------------------------------------------------------------
#designate::config::designate_config:
#  handler:nova_fixed/formatv4:
#    value: "'vm-%(octet0)s-%(octet1)s-%(octet2)s-%(octet3)s.%(zone)s'"
#  handler:nova_fixed/formatv6:
#    value: "'vm-%(octet0)s-%(octet1)s-%(octet2)s-%(octet3)s.%(zone)s-%(octet4)s-%(octet5)s-%(octet6)s-%(octet7)s.%(zone)s'"
